name: Test git-hex

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    - cron: "0 6 * * 1"

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install mcp-bash framework
        run: |
          curl -fsSL https://raw.githubusercontent.com/yaniv-golan/mcp-bash-framework/v0.6.0/install.sh | bash -s -- --version v0.6.0
          echo "$HOME/.local/share/mcp-bash/bin" >> $GITHUB_PATH
          echo "$HOME/.local/bin" >> $GITHUB_PATH
          echo "PATH=$HOME/.local/share/mcp-bash/bin:$PATH" >> "$GITHUB_ENV"
          echo "MCPBASH_HOME=$HOME/.local/share/mcp-bash" >> $GITHUB_ENV

      - name: Install lint dependencies
        run: |
          sudo apt-get update && sudo apt-get install -y jq shellcheck shfmt

      - name: Run lint
        run: ./test/lint.sh

  tests:
    needs: lint
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    runs-on: ${{ matrix.os }}
    defaults:
      run:
        shell: bash
    env:
      KEEP_INTEGRATION_LOGS: "1"
      MCPBASH_KEEP_LOGS: "1"
      GIT_HEX_DEBUG: "true"
      GIT_HEX_DEBUG_REBASE: "true"
      MCPBASH_CI_MODE: "1"
      MCPBASH_CI_VERBOSE: "1"
      MCPBASH_TRACE_TOOLS: "true"
      MCPBASH_TRACE_MAX_BYTES: "60000"
    steps:
      - uses: actions/checkout@v4

      - name: Set temp log dir
        run: |
          echo "GITHEX_INTEGRATION_TMP=${RUNNER_TEMP}/githex-integration" >> "$GITHUB_ENV"
          echo "MCPBASH_LOG_DIR=${RUNNER_TEMP}/mcpbash-logs" >> "$GITHUB_ENV"
          echo "MCPBASH_PROJECT_ROOT=${GITHUB_WORKSPACE}" >> "$GITHUB_ENV"

      - name: Install mcp-bash framework
        run: |
          curl -fsSL https://raw.githubusercontent.com/yaniv-golan/mcp-bash-framework/v0.6.0/install.sh | bash -s -- --version v0.6.0
          echo "$HOME/.local/share/mcp-bash/bin" >> $GITHUB_PATH
          echo "$HOME/.local/bin" >> $GITHUB_PATH
          echo "PATH=$HOME/.local/share/mcp-bash/bin:$PATH" >> "$GITHUB_ENV"
          echo "MCPBASH_HOME=$HOME/.local/share/mcp-bash" >> "$GITHUB_ENV"

      - name: Install test dependencies
        run: |
          if [[ "$RUNNER_OS" == "Linux" ]]; then
            sudo apt-get update && sudo apt-get install -y jq gojq || sudo apt-get install -y jq
          elif [[ "$RUNNER_OS" == "macOS" ]]; then
            brew install jq gojq || brew install jq
          else
            choco install jq -y
          fi

      - name: Validate project
        run: mcp-bash validate

      - name: Run integration tests
        id: integration
        run: |
          start=$(date +%s)
          if ./test/integration/run.sh; then
            status=0
          else
            status=$?
          fi
          end=$(date +%s)
          echo "duration=$((end - start))" >> "$GITHUB_OUTPUT"
          exit "${status}"
      - name: Run security tests
        if: matrix.os != 'windows-latest'
        run: ./test/security/run.sh

      - name: Enforce Windows integration budget
        if: matrix.os == 'windows-latest'
        run: |
          duration="${{ steps.integration.outputs.duration }}"
          warn_budget=240
          fail_budget=900
          if [ -n "${duration}" ] && [ "${duration}" -gt "${warn_budget}" ]; then
            echo "::warning ::Integration duration ${duration}s exceeded warning budget ${warn_budget}s"
          fi
          if [ -n "${duration}" ] && [ "${duration}" -gt "${fail_budget}" ]; then
            echo "Integration exceeded fail budget (${duration}s)" >&2
            exit 1
          fi

      - name: Upload integration logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: test-logs-${{ matrix.os }}
          path: ${{ env.GITHEX_INTEGRATION_TMP }}/
          retention-days: 7

      - name: Upload mcp-bash logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: mcpbash-logs-${{ matrix.os }}
          path: ${{ env.MCPBASH_LOG_DIR }}/
          retention-days: 7

  nightly:
    if: github.event_name == 'schedule'
    runs-on: ubuntu-latest
    env:
      KEEP_INTEGRATION_LOGS: "1"
      MCPBASH_KEEP_LOGS: "1"
      GIT_HEX_DEBUG: "true"
      GIT_HEX_DEBUG_REBASE: "true"
      MCPBASH_CI_MODE: "1"
      MCPBASH_CI_VERBOSE: "1"
      MCPBASH_TRACE_TOOLS: "true"
      MCPBASH_TRACE_MAX_BYTES: "60000"
    steps:
      - uses: actions/checkout@v4

      - name: Set temp log dir
        run: |
          echo "GITHEX_INTEGRATION_TMP=${RUNNER_TEMP}/githex-integration" >> "$GITHUB_ENV"
          echo "MCPBASH_LOG_DIR=${RUNNER_TEMP}/mcpbash-logs" >> "$GITHUB_ENV"
          echo "MCPBASH_PROJECT_ROOT=${GITHUB_WORKSPACE}" >> "$GITHUB_ENV"

      - name: Install mcp-bash framework
        run: |
          curl -fsSL https://raw.githubusercontent.com/yaniv-golan/mcp-bash-framework/v0.6.0/install.sh | bash -s -- --version v0.6.0
          echo "$HOME/.local/share/mcp-bash/bin" >> $GITHUB_PATH
          echo "$HOME/.local/bin" >> $GITHUB_PATH
          echo "PATH=$HOME/.local/share/mcp-bash/bin:$PATH" >> "$GITHUB_ENV"
          echo "MCPBASH_HOME=$HOME/.local/share/mcp-bash" >> "$GITHUB_ENV"

      - name: Install test dependencies
        run: |
          sudo apt-get update && sudo apt-get install -y jq gojq shellcheck shfmt || sudo apt-get install -y jq shellcheck shfmt

      - name: Validate project
        run: mcp-bash validate

      - name: Run full test suite
        run: ./test/run.sh

      - name: Upload integration logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: nightly-logs
          path: ${{ env.GITHEX_INTEGRATION_TMP }}/
          retention-days: 7

      - name: Upload mcp-bash logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: nightly-mcpbash-logs
          path: ${{ env.MCPBASH_LOG_DIR }}/
          retention-days: 7
      - name: Verify registry and tool availability
        run: |
          mcp-bash registry refresh --project-root "$MCPBASH_PROJECT_ROOT"
          mcp-bash run-tool git-hex-getRebasePlan \
            --project-root "$MCPBASH_PROJECT_ROOT" \
            --roots "$MCPBASH_PROJECT_ROOT" \
            --args '{}' \
            --timeout 10 \
            --verbose
      - name: Verify registry and tool availability
        run: |
          mcp-bash registry refresh --project-root "$MCPBASH_PROJECT_ROOT"
          mcp-bash run-tool git-hex-getRebasePlan \
            --project-root "$MCPBASH_PROJECT_ROOT" \
            --roots "$MCPBASH_PROJECT_ROOT" \
            --args '{}' \
            --timeout 10 \
            --verbose
